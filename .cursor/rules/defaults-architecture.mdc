# Defaults Architecture Rule

This rule enforces the centralized defaults architecture for DealGapIQ.

## CRITICAL: Never Hardcode Financial Defaults

The following values MUST come from the API, never hardcoded in frontend or mobile code:

### Financing Defaults
- `interest_rate` - Current mortgage rate
- `down_payment_pct` - Down payment percentage
- `loan_term_years` - Loan term
- `closing_costs_pct` - Closing costs percentage

### Operating Defaults
- `vacancy_rate` - Vacancy rate percentage
- `property_management_pct` - Property management fee
- `maintenance_pct` - Maintenance reserve percentage
- `insurance_pct` - Insurance percentage of purchase price

### Strategy-Specific Defaults
- STR: `platform_fees_pct`, `str_management_pct`, `cleaning_cost_per_turnover`
- BRRRR: `refinance_ltv`, `refinance_interest_rate`, `refinance_closing_costs_pct`
- Flip: `hard_money_ltv`, `hard_money_rate`, `selling_costs_pct`
- House Hack: `fha_down_payment_pct`, `fha_mip_rate`
- Wholesale: `assignment_fee`, `target_purchase_discount_pct`

### Growth Rates
- `appreciation_rate`
- `rent_growth_rate`
- `expense_growth_rate`

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                    DEFAULTS RESOLUTION FLOW                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────────┐                                            │
│  │ 1. System Defaults│  backend/app/core/defaults.py             │
│  │   (Base values)   │  Single source of truth                   │
│  └────────┬─────────┘                                            │
│           │                                                       │
│           ▼                                                       │
│  ┌──────────────────┐                                            │
│  │ 2. Market Adjust │  ZIP-specific adjustments                  │
│  │   (Location)     │  assumptions_service.py                    │
│  └────────┬─────────┘                                            │
│           │                                                       │
│           ▼                                                       │
│  ┌──────────────────┐                                            │
│  │ 3. User Profile  │  User's saved preferences                  │
│  │   (Personal)     │  /api/v1/users/me/assumptions              │
│  └────────┬─────────┘                                            │
│           │                                                       │
│           ▼                                                       │
│  ┌──────────────────┐                                            │
│  │ 4. Property Data │  Actual property values                    │
│  │   (API response) │  Tax, rent, insurance from data            │
│  └────────┬─────────┘                                            │
│           │                                                       │
│           ▼                                                       │
│  ┌──────────────────┐                                            │
│  │ 5. Session       │  Deal Maker adjustments                    │
│  │   (User edits)   │  Highest priority                          │
│  └──────────────────┘                                            │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

## Correct Usage Pattern

### Frontend (React/Next.js)

```typescript
// CORRECT: Import from centralized service
import { useDefaults } from '@/hooks/useDefaults'

function MyComponent({ zipCode }) {
  const { defaults, loading, error } = useDefaults(zipCode)
  
  // Use defaults.financing.interest_rate, etc.
  const interestRate = defaults?.financing.interest_rate ?? 0.06
}
```

### Mobile (React Native)

```typescript
// CORRECT: Import from centralized service
import { useDefaults } from '../services/defaults'

function MyScreen({ zipCode }) {
  const { defaults, loading } = useDefaults(zipCode)
  
  // Use defaults.financing.interest_rate, etc.
}
```

## FORBIDDEN Patterns

```typescript
// ❌ WRONG: Hardcoded default value
const interestRate = 0.06

// ❌ WRONG: Hardcoded in component
const DEFAULT_VACANCY = 0.05

// ❌ WRONG: Inline fallback without fetching
const downPayment = assumedDownPayment || 0.20

// ❌ WRONG: Constants file with hardcoded defaults
export const DEFAULTS = {
  INTEREST_RATE: 0.07,  // DON'T DO THIS
}
```

## API Endpoints

| Endpoint | Description |
|----------|-------------|
| `GET /api/v1/defaults` | System defaults from backend |
| `GET /api/v1/defaults/resolved?zip_code=XXXXX` | Fully resolved defaults for location |
| `GET /api/v1/users/me/assumptions` | User's saved preferences |
| `PUT /api/v1/users/me/assumptions` | Update user's preferences |
| `GET /api/v1/market/assumptions?zip_code=XXXXX` | Market-specific adjustments |

## Key Files

### Backend (Source of Truth)
- `backend/app/core/defaults.py` - All default values defined here
- `backend/app/services/assumptions_service.py` - Market adjustments
- `backend/app/routers/users.py` - User assumptions endpoints

### Frontend (Consumers)
- `frontend/src/services/defaults.ts` - Defaults service
- `frontend/src/hooks/useDefaults.ts` - React hook
- `frontend/src/stores/index.ts` - Types only, NO values

### Mobile (Consumers)
- `mobile/services/defaults.ts` - Defaults service and hook

## Enforcement

1. **TypeScript**: Types imported from `@/stores/index.ts`, values from `useDefaults()`
2. **Linting**: ESLint rule warns on numeric literals that look like percentages
3. **Code Review**: This rule is checked by AI and human reviewers
4. **Runtime**: `useDefaults()` hook validates values are fetched, not hardcoded

## When Adding New Defaults

1. Add to `backend/app/core/defaults.py` dataclass
2. Add to `get_all_defaults()` function
3. Update TypeScript types in `frontend/src/stores/index.ts`
4. Values automatically available via `useDefaults()` hook

## Migration Notes

If you find hardcoded defaults during development:
1. Replace with `useDefaults()` hook
2. Use optional chaining with nullish coalescing for loading states
3. Never add a local fallback value - let the API provide defaults

---

## IQ Verdict Scoring Architecture

### Core Value Proposition

> Every property can be a good investment at the right price.
> 
> DealGapIQ answers two questions:
> 1. **What price makes this deal work?** (Breakeven) - based on user's financing terms
> 2. **How likely can you get that price?** (Deal Gap + Motivation) - based on market signals

### IQ Score Components

| Component | Weight | Description |
|-----------|--------|-------------|
| Deal Gap | 50% | Distance from asking to breakeven |
| Seller Motivation | 30% | Likelihood of negotiation success |
| Market Context | 20% | Days on market, buyer/seller market |

### Price Points (Must Be Clear to User)

1. **Breakeven Price** - Maximum price for $0 monthly cash flow (based on USER'S assumptions)
2. **Target Buy Price** - Breakeven minus default discount (typically 5%)
3. **Wholesale Price** - Breakeven × 0.70 (for assignment deals)

### Off-Market Properties

When `listing_status` is not FOR_SALE:
- Use AVM (Zestimate) as baseline for Deal Gap calculation
- Display: "No asking price - using market estimate of $X"
- Allow user to input expected price in Deal Maker

### Seller Motivation Score

The `calculate_seller_motivation()` function in `calculators.py` provides:
- Individual indicators (DOM, price reductions, foreclosure, etc.)
- Composite score (0-100)
- Negotiation leverage level
- Suggested discount range

**Must be integrated into Deal Gap display**, not shown separately.

---

## Deal Maker IQ Architecture

### State Management

Deal Maker MUST use `worksheetStore` (Zustand), NOT local `useState`.

```typescript
// ❌ WRONG: Isolated local state
const [state, setState] = useState<DealMakerState>(initialState)

// ✅ CORRECT: Shared store
const { assumptions, updateAssumption } = useWorksheetStore()
```

### Field Mapping

| Deal Maker Field | worksheetStore Field |
|-----------------|---------------------|
| buyPrice | purchasePrice |
| downPaymentPercent | downPaymentPct |
| closingCostsPercent | closingCostsPct |
| interestRate | interestRate |
| loanTermYears | loanTermYears |
| rehabBudget | rehabCosts |
| arv | arv |
| monthlyRent | monthlyRent |
| vacancyRate | vacancyRate |
| maintenanceRate | maintenancePct |
| managementRate | managementPct |
| annualPropertyTax | propertyTaxes |
| annualInsurance | insurance |
| monthlyHoa | hoaFees |

### Recalculation Flow

```
User adjusts slider in Deal Maker
        ↓
worksheetStore.updateAssumption() called
        ↓
Zustand state updates
        ↓
recalculateProjections() → client-side projections update
recalculateWorksheetMetrics() → debounced API call
        ↓
All subscribed components re-render with new values
```

### "See Results" Button

Deal Maker must have a persistent way to see results without completing all tabs:
- Floating or fixed position
- Shows live-updating: Deal Score, Cash Flow, CoC
- Click navigates to full results

---

## User Profile Assumptions

### Onboarding Flow

During registration, after experience level:
1. **Financing Type** - Conventional/FHA/VA/Cash/Hard Money
2. Each option sets appropriate defaults
3. Display: "Results based on these terms. Customize in Dashboard."

### Dashboard Editor

Users can edit detailed assumptions in Dashboard:
- All financing parameters
- All operating expense rates
- Strategy-specific settings
- Saved via `PUT /api/v1/users/me/assumptions`

### Display Transparency

When showing calculated values:
- Include "Based on your investor profile" or similar
- Offer "See how we calculated this" expansion
- Link to Dashboard for customization
