# Nixpacks configuration for Railway deployment
#
# WeasyPrint requires system shared libraries (GLib/Cairo/Pango/etc.)
# loadable via cffi.dlopen() / ctypes.util.find_library().
#
# nixLibs  — installs Nix packages AND adds them to LD_LIBRARY_PATH
#            so ctypes/cffi can locate them at runtime.
# nixPkgs  — installs Nix packages for data files (fonts, MIME DB)
#            that don't need to be on the library search path.

[phases.setup]
nixLibs = [
  "glib",          # libgobject-2.0, libglib-2.0
  "cairo",         # libcairo
  "pango",         # libpango-1.0, libpangocairo-1.0, libpangoft2-1.0
  "gdk-pixbuf",    # libgdk_pixbuf-2.0
  "harfbuzz",      # libharfbuzz
  "fontconfig",    # libfontconfig
  "freetype",      # libfreetype
  "libffi",        # libffi
]
nixPkgs = [
  "shared-mime-info",  # MIME type database
  "liberation_ttf",    # Liberation font family (print-quality)
]
# Nix Python packages expose `python3` but not `python`.
# Create the symlink so Nixpacks' auto-generated venv step works.
cmds = ["ln -sf $(which python3) /usr/bin/python 2>/dev/null || true"]

# Override the install phase to use `python3` explicitly, in case the
# symlink above runs before Python is on PATH.
[phases.install]
cmds = [
  "python3 -m venv --copies /opt/venv",
  ". /opt/venv/bin/activate && pip install --upgrade pip && pip install -r requirements.txt",
]
