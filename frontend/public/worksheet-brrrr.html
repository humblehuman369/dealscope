<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InvestIQ - BRRRR Worksheet</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      /* InvestIQ Brand Colors - Pacific Teal */
      --iq-teal: #007ea7;
      --iq-teal-dark: #006080;
      --iq-teal-light: #33a5c4;
      
      /* BRRRR Strategy Color - Purple/Violet accent */
      --brrrr-accent: #7c3aed;
      --brrrr-accent-light: #a78bfa;
      --brrrr-accent-bg: rgba(124, 58, 237, 0.1);
      
      /* Background Colors */
      --ws-bg: #ffffff;
      --ws-bg-alt: #f8fafc;
      --ws-card: #ffffff;
      
      /* Border Colors */
      --ws-border: #e2e8f0;
      --ws-border-light: #f1f5f9;
      
      /* Text Colors */
      --ws-text-primary: #1e293b;
      --ws-text-secondary: #64748b;
      --ws-text-muted: #94a3b8;
      --ws-text-label: #475569;
      
      /* Status Colors */
      --ws-positive: #10b981;
      --ws-positive-light: rgba(16, 185, 129, 0.15);
      --ws-negative: #dc2626;
      --ws-negative-light: #fee2e2;
      --ws-warning: #f59e0b;
      --ws-warning-light: rgba(245, 158, 11, 0.15);
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #ffffff;
      min-height: 100vh;
      color: var(--ws-text-primary);
    }
    
    /* Top Bar */
    .worksheet-topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 24px;
      background: white;
      border-bottom: 1px solid var(--ws-border);
      box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    }
    
    .worksheet-topbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .worksheet-back-link {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
      color: var(--ws-text-secondary);
      font-size: 14px;
      font-weight: 500;
      border-radius: 8px;
      text-decoration: none;
      transition: all 0.15s ease;
    }
    
    .worksheet-back-link:hover {
      background: var(--ws-bg-alt);
      color: var(--ws-text-primary);
    }
    
    .worksheet-property-info {
      border-left: 1px solid var(--ws-border);
      padding-left: 16px;
    }
    
    .worksheet-property-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--ws-text-primary);
    }
    
    .worksheet-property-subtitle {
      font-size: 13px;
      color: var(--ws-text-secondary);
    }

    .worksheet-property-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .strategy-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--brrrr-accent-bg);
      border: 1px solid var(--brrrr-accent-light);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: var(--brrrr-accent);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .worksheet-price-badge {
      font-size: 18px;
      font-weight: 700;
      color: var(--brrrr-accent);
      padding: 8px 16px;
      background: var(--brrrr-accent-bg);
      border-radius: 8px;
      border: 1px solid var(--brrrr-accent-light);
    }
    
    /* Tab Navigation */
    .worksheet-tab-nav {
      display: flex;
      align-items: center;
      gap: 8px;
      background: white;
      border-bottom: 2px solid var(--ws-border);
      padding: 0 24px;
    }
    
    .worksheet-tabs-scroll {
      display: flex;
      gap: 4px;
      overflow-x: auto;
      flex: 1;
      min-width: 0;
    }
    
    .worksheet-tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 14px 16px;
      font-size: 13px;
      font-weight: 500;
      color: var(--ws-text-secondary);
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }
    
    .worksheet-tab:hover {
      color: var(--ws-text-primary);
      background: var(--ws-bg-alt);
    }
    
    .worksheet-tab.active {
      color: var(--brrrr-accent);
      border-bottom-color: var(--brrrr-accent);
      background: var(--brrrr-accent-bg);
    }
    
    /* Main Content Area */
    .worksheet-main-area {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 20px;
      padding: 24px;
      max-width: 1600px;
      margin: 0 auto;
    }
    
    /* Help Panel */
    .worksheet-help-panel {
      width: 100%;
      background: white;
      border-radius: 12px;
      border: 1px solid var(--ws-border);
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      height: fit-content;
      position: sticky;
      top: 24px;
    }
    
    .worksheet-help-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      background: linear-gradient(135deg, var(--brrrr-accent-bg) 0%, #f5f3ff 100%);
      border-bottom: 1px solid var(--brrrr-accent-light);
      border-radius: 12px 12px 0 0;
      font-weight: 600;
      font-size: 14px;
      color: var(--brrrr-accent);
    }
    
    .worksheet-help-list {
      padding: 16px;
      list-style: none;
    }
    
    .worksheet-help-item {
      display: flex;
      gap: 10px;
      font-size: 13px;
      color: var(--ws-text-secondary);
      line-height: 1.5;
      margin-bottom: 12px;
    }
    
    .help-icon {
      color: var(--brrrr-accent);
      flex-shrink: 0;
      margin-top: 2px;
    }
    
    /* Content Area */
    .worksheet-content-area {
      flex: 1;
      min-width: 0;
    }
    
    /* Summary Cards */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: clamp(6px, 1vw, 12px);
      margin-bottom: 24px;
    }
    
    .summary-card {
      background: white;
      border: 1px solid var(--ws-border);
      border-radius: 12px;
      padding: 14px 16px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
    }
    
    .summary-card.highlight {
      background: linear-gradient(135deg, var(--brrrr-accent-bg) 0%, white 100%);
      border-color: var(--brrrr-accent-light);
    }
    
    .summary-card-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--ws-text-muted);
      margin-bottom: 6px;
    }
    
    .summary-card-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--ws-text-primary);
      line-height: 1.2;
    }
    
    .summary-card-value.positive {
      color: var(--ws-positive);
    }
    
    .summary-card-value.highlight {
      color: var(--brrrr-accent);
    }
    
    .summary-card-subtitle {
      font-size: 11px;
      color: var(--ws-text-secondary);
      margin-top: 2px;
    }
    
    /* Section Cards */
    .section-card {
      background-color: var(--ws-card);
      border: 1px solid var(--ws-border);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      margin-bottom: 16px;
    }
    
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(0, 126, 167, 0.08) 0%, #f8fafc 100%);
      border-bottom: 1px solid var(--ws-border);
    }
    
    .section-header.brrrr-highlight {
      background: linear-gradient(135deg, var(--brrrr-accent-bg) 0%, #f8fafc 100%);
    }
    
    .section-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--iq-teal-dark);
    }
    
    .section-title.brrrr {
      color: var(--brrrr-accent);
    }
    
    .section-badge {
      font-size: 10px;
      padding: 3px 8px;
      background: var(--brrrr-accent);
      color: white;
      border-radius: 10px;
      font-weight: 600;
    }
    
    /* Data Rows */
    .data-row {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: start;
      gap: 16px;
      padding: 10px 16px;
      border-bottom: 1px solid var(--ws-border-light);
      font-size: 14px;
    }
    
    .data-row:last-child {
      border-bottom: none;
    }
    
    .data-row:hover {
      background-color: rgba(0, 126, 167, 0.04);
    }
    
    .data-row.total {
      background: linear-gradient(135deg, rgba(0, 126, 167, 0.1) 0%, rgba(0, 126, 167, 0.05) 100%);
      font-weight: 600;
    }
    
    .data-row.brrrr-total {
      background: linear-gradient(135deg, var(--brrrr-accent-bg) 0%, rgba(124, 58, 237, 0.05) 100%);
    }
    
    .data-row.calculated {
      background: var(--ws-bg-alt);
    }
    
    .data-label {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--ws-text-label);
    }
    
    .data-label .icon {
      color: var(--iq-teal);
    }
    
    .value-primary {
      font-weight: 500;
      color: var(--ws-text-primary);
      white-space: nowrap;
    }
    
    .value-secondary {
      font-size: 12px;
      color: var(--ws-text-muted);
    }
    
    .value-negative {
      color: var(--ws-negative);
    }
    
    .value-positive {
      color: var(--ws-positive);
    }
    
    .value-highlight {
      color: var(--brrrr-accent);
    }
    
    /* Slider Styles */
    .data-row.has-slider {
      grid-template-columns: 140px 1fr auto;
      gap: 12px;
    }
    
    .slider-container {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }
    
    .slider-wrapper {
      flex: 1;
      position: relative;
      height: 24px;
      display: flex;
      align-items: center;
    }
    
    .slider-input {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #e2e8f0;
      outline: none;
      cursor: pointer;
    }
    
    .slider-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: white;
      border: 2px solid var(--iq-teal);
      box-shadow: 0 2px 6px rgba(0, 126, 167, 0.3);
      cursor: grab;
    }
    
    .slider-input.brrrr::-webkit-slider-thumb {
      border-color: var(--brrrr-accent);
      box-shadow: 0 2px 6px rgba(124, 58, 237, 0.3);
    }
    
    .slider-value {
      width: 85px;
      min-width: unset;
      padding: 6px 8px;
      background: var(--ws-bg-alt);
      border: 1px solid var(--ws-border);
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      color: var(--ws-text-primary);
      text-align: right;
    }

    .slider-value.min-width-60 { min-width: 60px; }
    .slider-value.min-width-70 { min-width: 70px; }
    .slider-value.min-width-80 { min-width: 80px; }
    .slider-value.min-width-90 { min-width: 90px; }
    
    .slider-value:focus {
      outline: none;
      border-color: var(--iq-teal);
      box-shadow: 0 0 0 3px rgba(0, 126, 167, 0.15);
    }
    
    .slider-dual-value {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
    }
    
    .slider-secondary {
      font-size: 11px;
      color: var(--ws-text-muted);
    }
    
    /* Select Input */
    .select-input {
      padding: 8px 32px 8px 12px;
      background: white;
      border: 1px solid var(--ws-border);
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      color: var(--ws-text-primary);
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
    }
    
    /* Subsection Headers */
    .subsection-header {
      padding: 8px 16px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .subsection-header.income {
      background: var(--ws-positive-light);
      color: var(--ws-positive);
    }
    
    .subsection-header.expenses {
      background: var(--ws-negative-light);
      color: var(--ws-negative);
    }
    
    .subsection-header.holding {
      background: var(--ws-warning-light);
      color: var(--ws-warning);
    }
    
    .subsection-header.refinance {
      background: var(--brrrr-accent-bg);
      color: var(--brrrr-accent);
    }
    
    /* ===== PROFIT FINDER ===== */
    .price-position-visual {
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 12px;
      min-height: 420px;
      gap: 8px;
    }
    .marker-column {
      width: 85px;
      position: relative;
      flex-shrink: 0;
    }
    .simple-marker {
      position: absolute;
      display: flex;
      align-items: center;
      gap: 2px;
      transform: translateY(-50%);
      transition: top 0.3s ease;
    }
    .marker-column.left .simple-marker,
    .marker-column.right .simple-marker {
      right: 0;
      left: 0;
      justify-content: center;
    }
    .marker-stack {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      line-height: 1.1;
    }
    .marker-name { font-size: 10px; font-weight: 700; text-transform: uppercase; }
    .marker-val { font-size: 11px; font-weight: 700; }
    .marker-arrow { font-size: 10px; }
    #purchase-price-marker .marker-name,
    #purchase-price-marker .marker-val,
    #purchase-price-marker .marker-arrow { color: var(--iq-teal); }
    #list-price-marker .marker-name,
    #list-price-marker .marker-val,
    #list-price-marker .marker-arrow { color: #dc2626; }
    #breakeven-marker .marker-name,
    #breakeven-marker .marker-val,
    #breakeven-marker .marker-arrow { color: #64748b; }
    .price-scale-bar { width: 60px; flex-shrink: 0; }
    .price-scale-bar img { display: block; width: 60px; height: 400px; }
    .cashflow-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 12px 16px;
      margin: 0 8px 8px;
      border-radius: 8px;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.12) 0%, rgba(16, 185, 129, 0.04) 100%);
      border: 1px solid rgba(16, 185, 129, 0.25);
    }
    .cashflow-indicator.negative {
      background: linear-gradient(135deg, rgba(220, 38, 38, 0.12) 0%, rgba(220, 38, 38, 0.04) 100%);
      border-color: rgba(220, 38, 38, 0.25);
    }
    .cashflow-indicator .cf-label { font-size: 12px; color: var(--ws-text-muted); }
    .cashflow-indicator .cf-amount { font-size: 18px; font-weight: 700; color: #10b981; }
    .cashflow-indicator.negative .cf-amount { color: #dc2626; }
    .cashflow-indicator .cf-status { font-size: 12px; font-weight: 600; color: #10b981; padding: 2px 8px; background: rgba(16, 185, 129, 0.15); border-radius: 10px; }
    .cashflow-indicator.negative .cf-status { color: #dc2626; background: rgba(220, 38, 38, 0.15); }
    .slider-value.pct-field { width: 65px; }

    /* Charts Sidebar */
    .worksheet-charts-sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: sticky;
      top: 24px;
      height: fit-content;
    }
    
    .chart-card {
      background: white;
      border: 1px solid var(--ws-border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
    }
    
    .chart-card.brrrr-highlight {
      border-color: var(--brrrr-accent-light);
      background: linear-gradient(180deg, var(--brrrr-accent-bg) 0%, white 100%);
    }
    
    .chart-card-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--iq-teal-dark);
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--ws-border-light);
    }
    
    .chart-card-title.brrrr {
      color: var(--brrrr-accent);
    }
    
    /* ===== PRICING LADDER ===== */
    .pricing-ladder {
      position: relative;
      padding: 16px 0;
    }
    
    .pricing-ladder-track {
      position: absolute;
      left: 50%;
      top: 20px;
      bottom: 20px;
      width: 4px;
      background: linear-gradient(180deg, #10b981 0%, var(--brrrr-accent-light) 50%, var(--brrrr-accent) 100%);
      border-radius: 2px;
      transform: translateX(-50%);
    }
    
    .pricing-ladder-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
      position: relative;
    }
    
    .pricing-ladder-item.highlight {
      background: var(--brrrr-accent-bg);
      margin: 0 -16px;
      padding: 8px 16px;
      border-radius: 8px;
    }
    
    .pricing-ladder-label {
      flex: 1;
      text-align: right;
      padding-right: 20px;
      font-size: 11px;
      color: var(--ws-text-muted);
    }
    
    .pricing-ladder-marker {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: white;
      border: 3px solid var(--ws-border);
      z-index: 1;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .pricing-ladder-marker.arv { border-color: #10b981; background: #10b981; }
    .pricing-ladder-marker.current { border-color: var(--brrrr-accent); background: var(--brrrr-accent); }
    .pricing-ladder-marker.refi { border-color: var(--brrrr-accent-light); background: white; }
    .pricing-ladder-marker.target { border-color: #eab308; background: #eab308; }
    .pricing-ladder-marker.mao { border-color: var(--iq-teal-dark); background: white; }
    
    .pricing-ladder-value {
      flex: 1;
      padding-left: 20px;
      font-size: 14px;
      font-weight: 600;
      color: var(--ws-text-primary);
    }
    
    .pricing-ladder-value.current { color: var(--brrrr-accent); }
    .pricing-ladder-value.arv { color: #10b981; }
    .pricing-ladder-value.target { color: #eab308; }
    
    .pricing-ladder-hint {
      display: block;
      font-size: 10px;
      font-weight: 500;
      color: var(--ws-text-muted);
    }
    
    .pricing-discount-indicator {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--ws-border-light);
    }
    
    .pricing-discount-bar {
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .pricing-discount-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    #recovery-fill {
      width: 94%;
    }
    
    .pricing-discount-fill.brrrr {
      background: linear-gradient(90deg, var(--brrrr-accent), var(--brrrr-accent-light));
    }
    
    .pricing-discount-label {
      font-size: 12px;
      color: var(--ws-text-secondary);
      text-align: center;
    }
    
    .pricing-discount-label span {
      font-weight: 600;
      color: var(--brrrr-accent);
    }

    /* Mini Stats Grid */
    .mini-stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .mini-stat {
      text-align: center;
      padding: 12px 8px;
      background: var(--ws-bg-alt);
      border-radius: 8px;
    }
    
    .mini-stat.highlight {
      background: var(--brrrr-accent-bg);
    }
    
    .mini-stat-value {
      font-size: 16px;
      font-weight: 700;
      color: var(--iq-teal);
    }
    
    .mini-stat-value.brrrr {
      color: var(--brrrr-accent);
    }
    
    .mini-stat-label {
      font-size: 10px;
      color: var(--ws-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-top: 4px;
    }
    
    /* Donut Chart */
    .mini-donut {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      position: relative;
    }
    
    .mini-donut-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .mini-donut-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--brrrr-accent);
    }
    
    .mini-donut-label {
      font-size: 8px;
      color: var(--ws-text-muted);
      text-transform: uppercase;
    }
    
    /* Progress Bars */
    .h-bar-item {
      margin-bottom: 12px;
    }
    
    .h-bar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    
    .h-bar-label {
      font-size: 11px;
      color: var(--ws-text-label);
    }
    
    .h-bar-value {
      font-size: 12px;
      font-weight: 600;
      color: var(--iq-teal);
    }

    .h-bar-value.positive {
      color: var(--ws-positive);
    }
    
    .h-bar-track {
      height: 6px;
      background: var(--ws-bg-alt);
      border-radius: 3px;
      overflow: hidden;
    }
    
    .h-bar-fill {
      height: 100%;
      border-radius: 3px;
      background: linear-gradient(90deg, var(--iq-teal) 0%, var(--iq-teal-light) 100%);
    }

    .h-bar-fill.full {
      width: 100%;
    }

    .h-bar-fill.positive {
      width: 8.8%;
      background: var(--ws-positive);
    }
    
    .h-bar-fill.brrrr {
      background: linear-gradient(90deg, var(--brrrr-accent) 0%, var(--brrrr-accent-light) 100%);
    }
    
    /* Stacked Bar */
    .stacked-bar {
      display: flex;
      height: 24px;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .stacked-bar.compact {
      height: 20px;
    }
    
    .stacked-bar-segment {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      color: white;
    }

    .stacked-bar-segment.interest { width: 79%; background: var(--ws-negative); }
    .stacked-bar-segment.tax { width: 12%; background: #f97316; }
    .stacked-bar-segment.other { width: 9%; background: #64748b; }
    
    .stacked-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .stacked-legend.tight {
      margin-top: 8px;
    }
    
    .stacked-legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      color: var(--ws-text-secondary);
    }
    
    .stacked-legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 2px;
    }

    .stacked-legend-dot.interest { background: var(--ws-negative); }
    .stacked-legend-dot.tax { background: #f97316; }
    
    /* Cash Out Indicator */
    .cash-out-indicator {
      text-align: center;
      padding: 16px;
      background: linear-gradient(135deg, var(--brrrr-accent-bg) 0%, white 100%);
      border-radius: 8px;
      margin-top: 8px;
    }
    
    .cash-out-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--brrrr-accent);
    }
    
    .cash-out-label {
      font-size: 11px;
      color: var(--ws-text-muted);
      text-transform: uppercase;
      margin-top: 4px;
    }
    
    .cash-out-status {
      display: inline-block;
      margin-top: 8px;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .cash-out-status.positive {
      background: var(--ws-positive-light);
      color: var(--ws-positive);
    }
    
    .cash-out-status.negative {
      background: var(--ws-negative-light);
      color: var(--ws-negative);
    }

    .brrrr-score-content {
      text-align: center;
      padding: 8px 0;
    }

    .brrrr-score-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--brrrr-accent);
      margin-top: 4px;
    }

    .brrrr-score-label {
      font-size: 11px;
      color: var(--ws-text-muted);
    }

    .cash-recovery-bars {
      margin-top: 16px;
    }

    .cost-breakdown-layout {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .mini-donut.cost-breakdown {
      background: conic-gradient(var(--iq-teal) 0deg 240deg, var(--brrrr-accent) 240deg 310deg, #f97316 310deg 360deg);
      width: 100px;
      height: 100px;
      flex-shrink: 0;
    }

    .cost-breakdown-details {
      flex: 1;
    }

    .cost-breakdown-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
    }

    .cost-breakdown-row:last-child {
      margin-bottom: 0;
    }

    .cost-breakdown-swatch {
      width: 10px;
      height: 10px;
      border-radius: 2px;
    }

    .cost-breakdown-swatch.purchase { background: var(--iq-teal); }
    .cost-breakdown-swatch.rehab { background: var(--brrrr-accent); }
    .cost-breakdown-swatch.costs { background: #f97316; }

    .cost-breakdown-label {
      font-size: 12px;
      color: var(--ws-text-secondary);
    }

    .cost-breakdown-value {
      font-size: 12px;
      font-weight: 600;
      margin-left: auto;
    }

    .holding-costs-timeline {
      padding: 8px 0;
    }

    .holding-costs-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .holding-costs-period {
      font-size: 11px;
      color: var(--ws-text-muted);
    }

    .holding-costs-total {
      font-size: 12px;
      font-weight: 600;
      color: var(--ws-negative);
    }

    .loan-comparison-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      text-align: center;
    }

    .loan-comparison-card {
      padding: 12px;
      background: var(--ws-bg-alt);
      border-radius: 8px;
    }

    .loan-comparison-card.refi {
      background: var(--brrrr-accent-bg);
    }

    .loan-comparison-label {
      font-size: 10px;
      color: var(--ws-text-muted);
      margin-bottom: 4px;
    }

    .loan-comparison-label.refi {
      color: var(--brrrr-accent);
    }

    .loan-comparison-value {
      font-size: 14px;
      font-weight: 600;
    }

    .loan-comparison-value.refi {
      color: var(--brrrr-accent);
    }

    .loan-comparison-subtext {
      font-size: 11px;
      color: var(--ws-negative);
    }

    .loan-comparison-subtext.refi {
      color: var(--ws-positive);
    }
    
    @media (max-width: 1200px) {
      .worksheet-main-area {
        grid-template-columns: 1fr 400px;
      }
      .worksheet-help-panel {
        display: none;
      }
      .summary-cards {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 900px) {
      .worksheet-main-area {
        grid-template-columns: 1fr;
      }
      .worksheet-charts-sidebar {
        position: static;
      }
      .summary-cards {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* Strategy Dropdown */
    .strategy-dropdown {
      position: relative;
      flex-shrink: 0;
      z-index: 100;
    }
    
    .strategy-dropdown-trigger {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(124, 58, 237, 0.3);
    }
    
    .strategy-dropdown-trigger:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(124, 58, 237, 0.4);
    }
    
    .strategy-dropdown-trigger .dropdown-arrow {
      transition: transform 0.2s ease;
    }
    
    .strategy-dropdown.open .dropdown-arrow {
      transform: rotate(180deg);
    }
    
    .strategy-dropdown-menu {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      min-width: 220px;
      background: white;
      border: 1px solid var(--ws-border);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s ease;
      z-index: 100;
      overflow: hidden;
    }
    
    .strategy-dropdown.open .strategy-dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .strategy-dropdown-header {
      padding: 12px 16px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--ws-text-muted);
      background: var(--ws-bg);
      border-bottom: 1px solid var(--ws-border-light);
    }
    
    .strategy-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.15s ease;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }
    
    .strategy-option:hover {
      background: rgba(124, 58, 237, 0.08);
    }
    
    .strategy-option.active {
      background: rgba(124, 58, 237, 0.12);
    }
    
    .strategy-option-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .strategy-option-icon.ltr {
      background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
      color: #007ea7;
    }
    
    .strategy-option-icon.brrrr {
      background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
      color: #7c3aed;
    }
    
    .strategy-option-icon.flip {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #d97706;
    }
    
    .strategy-option-icon.str {
      background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      color: #16a34a;
    }

    .strategy-option-icon.wholesale {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      color: #2563eb;
    }

    .strategy-option-icon.househack {
      background: rgba(5, 150, 105, 0.15);
      color: #059669;
    }
    
    .strategy-option-content {
      flex: 1;
    }
    
    .strategy-option-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--ws-text-primary);
      margin-bottom: 2px;
    }
    
    .strategy-option-desc {
      font-size: 12px;
      color: var(--ws-text-muted);
    }
    
    .strategy-option-check {
      width: 20px;
      height: 20px;
      color: #7c3aed;
      opacity: 0;
    }
    
    .strategy-option.active .strategy-option-check {
      opacity: 1;
    }
    
    .strategy-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--ws-border-light);
      color: var(--ws-text-muted);
      border-radius: 4px;
      margin-left: 8px;
    }

    .summary-card.deal-score {
      background: linear-gradient(135deg, var(--brrrr-accent-bg) 0%, white 100%);
    }

    .summary-card-value.deal-score {
      color: var(--brrrr-accent);
    }
  </style>
</head>
<body>
  <!-- Top Bar -->
  <header class="worksheet-topbar">
    <div class="worksheet-topbar-left">
      <a href="#" class="worksheet-back-link">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        <span>Back</span>
      </a>
      <div class="worksheet-property-info">
        <div class="worksheet-property-header">
          <h1 class="worksheet-property-title" id="property-title">2847 Oak Street Drive</h1>
          <span class="strategy-badge">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>
            </svg>
            BRRRR
          </span>
        </div>
        <p class="worksheet-property-subtitle" id="property-subtitle">Austin, TX 78745 • 3 BR • 2 BA • 1,450 Sq.Ft.</p>
      </div>
    </div>
    <div class="worksheet-price-badge" id="property-price-badge">$285,000</div>
  </header>
  
  <!-- Tab Navigation -->
  <nav class="worksheet-tab-nav">
    <!-- Strategy Dropdown -->
    <div class="strategy-dropdown" id="strategy-dropdown">
        <button class="strategy-dropdown-trigger" onclick="toggleStrategyDropdown()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5"/>
            <path d="M2 12l10 5 10-5"/>
          </svg>
          <span id="current-strategy-name">BRRRR Worksheet</span>
          <svg class="dropdown-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6 6 6-6"/>
          </svg>
        </button>
        
        <!-- Dropdown Menu -->
        <div class="strategy-dropdown-menu">
          <div class="strategy-dropdown-header">Select Strategy</div>
          
          <!-- LTR Option -->
          <button class="strategy-option" data-strategy="ltr" onclick="selectStrategy('ltr', 'LTR Worksheet', 'worksheet-preview.html')">
            <div class="strategy-option-icon ltr">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
              </svg>
            </div>
            <div class="strategy-option-content">
              <div class="strategy-option-name">LTR (Long-Term Rental)</div>
              <div class="strategy-option-desc">Buy & hold for monthly cash flow</div>
            </div>
            <svg class="strategy-option-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
          </button>
          
          <!-- BRRRR Option -->
          <button class="strategy-option active" data-strategy="brrrr" onclick="selectStrategy('brrrr', 'BRRRR Worksheet', 'worksheet-brrrr.html')">
            <div class="strategy-option-icon brrrr">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5"/>
                <path d="M2 12l10 5 10-5"/>
              </svg>
            </div>
            <div class="strategy-option-content">
              <div class="strategy-option-name">BRRRR</div>
              <div class="strategy-option-desc">Buy, Rehab, Rent, Refinance, Repeat</div>
            </div>
            <svg class="strategy-option-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
          </button>
          
          <!-- Fix & Flip Option -->
          <button class="strategy-option" data-strategy="flip" onclick="selectStrategy('flip', 'Fix & Flip', 'worksheet-flip.html')">
            <div class="strategy-option-icon flip">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
              </svg>
            </div>
            <div class="strategy-option-content">
              <div class="strategy-option-name">Fix & Flip</div>
              <div class="strategy-option-desc">Buy, renovate, sell for profit</div>
            </div>
            <svg class="strategy-option-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
          </button>
          
          <!-- Wholesale Option -->
          <button class="strategy-option" data-strategy="wholesale" onclick="selectStrategy('wholesale', 'Wholesale', 'worksheet-wholesale.html')">
            <div class="strategy-option-icon wholesale">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 3h5v5"/>
                <path d="M8 21H3v-5"/>
                <path d="M21 3l-9 9"/>
                <path d="M3 21l9-9"/>
              </svg>
            </div>
            <div class="strategy-option-content">
              <div class="strategy-option-name">Wholesale</div>
              <div class="strategy-option-desc">Assign contracts for quick profit</div>
            </div>
            <svg class="strategy-option-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
          </button>
          
          <!-- STR Option -->
          <button class="strategy-option" data-strategy="str" onclick="selectStrategy('str', 'STR Worksheet', 'worksheet-str.html')">
            <div class="strategy-option-icon str">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
            </div>
            <div class="strategy-option-content">
              <div class="strategy-option-name">Short-Term Rental</div>
              <div class="strategy-option-desc">Vacation rentals & Airbnb</div>
            </div>
            <svg class="strategy-option-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
          </button>
          
          <button class="strategy-option" data-strategy="househack" onclick="selectStrategy('househack', 'House Hack', 'worksheet-househack.html')">
            <div class="strategy-option-icon househack">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
              </svg>
            </div>
            <div class="strategy-option-content">
              <div class="strategy-option-name">House Hack</div>
              <div class="strategy-option-desc">Live in one unit, rent the others</div>
            </div>
            <svg class="strategy-option-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
          </button>
        </div>
    </div>
    
    <div class="worksheet-tabs-scroll">
      <button class="worksheet-tab">Projections</button>
      <button class="worksheet-tab disabled">Comps <span class="strategy-badge">Soon</span></button>
      <button class="worksheet-tab disabled">ARV Analysis <span class="strategy-badge">Soon</span></button>
      <button class="worksheet-tab disabled">Rehab Scope <span class="strategy-badge">Soon</span></button>
    </div>
  </nav>
  
  <!-- Main Content -->
  <div class="worksheet-main-area">
    <!-- Help Panel -->
    <aside class="worksheet-help-panel">
      <div class="worksheet-help-header">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>
        </svg>
        BRRRR Strategy Tips
      </div>
      <ul class="worksheet-help-list">
        <li class="worksheet-help-item">
          <svg class="help-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 16v-4M12 8h.01"/>
          </svg>
          <span>Target 70-75% of ARV for purchase + rehab to leave room for profit</span>
        </li>
        <li class="worksheet-help-item">
          <svg class="help-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 16v-4M12 8h.01"/>
          </svg>
          <span>Plan for 3-6 months holding costs during rehab period</span>
        </li>
        <li class="worksheet-help-item">
          <svg class="help-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 16v-4M12 8h.01"/>
          </svg>
          <span>Refinance at 75% LTV is typical for cash-out refi</span>
        </li>
        <li class="worksheet-help-item">
          <svg class="help-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 16v-4M12 8h.01"/>
          </svg>
          <span>Goal: Recover 100% of cash invested at refinance</span>
        </li>
      </ul>
    </aside>
    
    <!-- Content Area -->
    <main class="worksheet-content-area">
      <!-- Summary Cards -->
      <div class="summary-cards">
        <div class="summary-card">
          <div class="summary-card-label">All-In Cost</div>
          <div class="summary-card-value" id="summary-all-in">$340,000</div>
          <div class="summary-card-subtitle">Purchase + Rehab</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-label">After Repair Value</div>
          <div class="summary-card-value positive" id="summary-arv">$425,000</div>
        </div>
        <div class="summary-card highlight">
          <div class="summary-card-label">Cash Out at Refi</div>
          <div class="summary-card-value highlight" id="summary-cash-out">$33,750</div>
          <div class="summary-card-subtitle">Money back in pocket</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-label">Cash Flow</div>
          <div class="summary-card-value positive" id="summary-cash-flow">$485/mo</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-label">CoC Return</div>
          <div class="summary-card-value positive" id="summary-coc">∞%</div>
          <div class="summary-card-subtitle" id="coc-subtitle">Infinite if $0 left in</div>
        </div>
        <div class="summary-card deal-score">
          <div class="summary-card-label">Deal Score</div>
          <div class="summary-card-value deal-score" id="summary-deal-score">92</div>
          <div class="summary-card-subtitle" id="score-label">Excellent Deal</div>
        </div>
      </div>
      
      <!-- Purchase & Rehab Section -->
      <div class="section-card">
        <div class="section-header">
          <span class="section-title">Purchase & Rehab</span>
        </div>
        <div class="section-content">
          <div class="data-row has-slider">
            <div class="data-label"><span>Purchase Price</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input" min="25000" max="1500000" value="285000" aria-label="Purchase Price">
              </div>
            </div>
            <input type="text" class="slider-value" value="$285,000" aria-label="Purchase Price">
          </div>
          <div class="data-row has-slider">
            <div class="data-label"><span>Rehab Costs</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input brrrr" min="0" max="100000" value="55000" aria-label="Rehab Costs">
              </div>
            </div>
            <input type="text" class="slider-value" value="$55,000" aria-label="Rehab Costs">
          </div>
          <div class="data-row has-slider">
            <div class="data-label"><span>Purchase Costs</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input" min="0" max="20000" value="8550" aria-label="Purchase Costs">
              </div>
            </div>
            <input type="text" class="slider-value" value="$8,550" aria-label="Purchase Costs">
          </div>
          <div class="data-row total">
            <div class="data-label"><span>Total All-In Cost</span></div>
            <div class="value-primary" id="total-all-in">$348,550</div>
          </div>
        </div>
      </div>
      
      <!-- Financing (Purchase) Section -->
      <div class="section-card">
        <div class="section-header">
          <span class="section-title">Financing (Purchase)</span>
          <span class="section-badge">Hard Money</span>
        </div>
        <div class="section-content">
          <div class="data-row has-slider">
            <div class="data-label"><span>Loan to Cost</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input" min="50" max="100" value="90" aria-label="Loan to Cost">
              </div>
            </div>
            <div class="slider-dual-value">
              <input type="text" class="slider-value min-width-60" value="90%" aria-label="Loan to Cost">
              <span class="slider-secondary">$306,000</span>
            </div>
          </div>
          <div class="data-row calculated">
            <div class="data-label"><span>Loan Amount</span></div>
            <div class="value-primary">$306,000</div>
          </div>
          <div class="data-row has-slider">
            <div class="data-label"><span>Interest Rate</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input" min="8" max="18" value="12" step="0.5" aria-label="Interest Rate (Purchase)">
              </div>
            </div>
            <input type="text" class="slider-value min-width-70" value="12.0%" aria-label="Interest Rate (Purchase)">
          </div>
          <div class="data-row has-slider">
            <div class="data-label"><span>Points</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input" min="0" max="5" value="2" step="0.5" aria-label="Points">
              </div>
            </div>
            <div class="slider-dual-value">
              <input type="text" class="slider-value min-width-70" value="2.0 pts" aria-label="Points">
              <span class="slider-secondary">$6,120</span>
            </div>
          </div>
          <div class="data-row total">
            <div class="data-label"><span>Cash to Close</span></div>
            <div class="value-primary">$56,670</div>
          </div>
        </div>
      </div>
      
      <!-- Valuation Section -->
      <div class="section-card">
        <div class="section-header brrrr-highlight">
          <span class="section-title brrrr">Valuation</span>
        </div>
        <div class="section-content">
          <div class="data-row has-slider">
            <div class="data-label"><span>After Repair Value</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input brrrr" min="50000" max="2000000" value="425000" aria-label="After Repair Value">
              </div>
            </div>
            <input type="text" class="slider-value" value="$425,000" aria-label="After Repair Value">
          </div>
          <div class="data-row calculated">
            <div class="data-label"><span>ARV Per Sq Ft</span></div>
            <div class="value-primary">$293</div>
          </div>
          <div class="data-row calculated">
            <div class="data-label"><span>Purchase Per Sq Ft</span></div>
            <div class="value-primary">$197</div>
          </div>
          <div class="data-row calculated">
            <div class="data-label"><span>Rehab Per Sq Ft</span></div>
            <div class="value-primary">$38</div>
          </div>
          <div class="data-row calculated">
            <div class="data-label"><span>All-In % of ARV</span></div>
            <div class="value-primary value-positive">82.0%</div>
          </div>
          <div class="data-row brrrr-total">
            <div class="data-label"><span>Equity Created</span></div>
            <div class="value-primary value-highlight">$76,450</div>
          </div>
        </div>
      </div>
      
      <!-- Holding Costs Section -->
      <div class="section-card">
        <div class="section-header">
          <span class="section-title">Holding Costs</span>
          <span class="section-badge">Rehab Period</span>
        </div>
        <div class="section-content">
          <div class="subsection-header holding">During Rehab (4 Months)</div>
          <div class="data-row has-slider">
            <div class="data-label"><span>Holding Period</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input" min="1" max="12" value="4" aria-label="Holding Period">
              </div>
            </div>
            <input type="text" class="slider-value min-width-90" value="4 months" aria-label="Holding Period">
          </div>
          <div class="data-row calculated">
            <div class="data-label"><span>Loan Interest</span></div>
            <div class="value-primary value-negative">-$12,240</div>
          </div>
          <div class="data-row has-slider">
            <div class="data-label"><span>Property Taxes</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input" min="0" max="1000" value="475" aria-label="Property Taxes (Rehab)">
              </div>
            </div>
            <div class="slider-dual-value">
              <input type="text" class="slider-value min-width-80" value="$475/mo" aria-label="Property Taxes (Rehab)">
              <span class="slider-secondary">$1,900</span>
            </div>
          </div>
          <div class="data-row has-slider">
            <div class="data-label"><span>Insurance</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input" min="0" max="500" value="150" aria-label="Insurance (Rehab)">
              </div>
            </div>
            <div class="slider-dual-value">
              <input type="text" class="slider-value min-width-80" value="$150/mo" aria-label="Insurance (Rehab)">
              <span class="slider-secondary">$600</span>
            </div>
          </div>
          <div class="data-row has-slider">
            <div class="data-label"><span>Utilities</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input" min="0" max="500" value="200" aria-label="Utilities">
              </div>
            </div>
            <div class="slider-dual-value">
              <input type="text" class="slider-value min-width-80" value="$200/mo" aria-label="Utilities">
              <span class="slider-secondary">$800</span>
            </div>
          </div>
          <div class="data-row total">
            <div class="data-label"><span>Total Holding Costs</span></div>
            <div class="value-primary value-negative">-$15,540</div>
          </div>
        </div>
      </div>
      
      <!-- Refinance Section -->
      <div class="section-card">
        <div class="section-header brrrr-highlight">
          <span class="section-title brrrr">Refinance</span>
          <span class="section-badge">Cash-Out Refi</span>
        </div>
        <div class="section-content">
          <div class="subsection-header refinance">New Loan Terms</div>
          <div class="data-row has-slider">
            <div class="data-label"><span>Loan to Value</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input brrrr" min="50" max="80" value="75" aria-label="Loan to Value">
              </div>
            </div>
            <div class="slider-dual-value">
              <input type="text" class="slider-value min-width-60" value="75%" aria-label="Loan to Value">
              <span class="slider-secondary">$318,750</span>
            </div>
          </div>
          <div class="data-row calculated">
            <div class="data-label"><span>New Loan Amount</span></div>
            <div class="value-primary">$318,750</div>
          </div>
          <div class="data-row has-slider">
            <div class="data-label"><span>Refinance Costs</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input" min="0" max="20000" value="6375" aria-label="Refinance Costs">
              </div>
            </div>
            <input type="text" class="slider-value" value="$6,375" aria-label="Refinance Costs">
          </div>
          <div class="data-row calculated">
            <div class="data-label"><span>Payoff Old Loan</span></div>
            <div class="value-primary value-negative">-$306,000</div>
          </div>
          <div class="data-row brrrr-total">
            <div class="data-label"><span>Net Cash Out</span></div>
            <div class="value-primary value-highlight" id="net-cash-out">$6,375</div>
          </div>
          
          <div class="subsection-header refinance">Total Cash Analysis</div>
          <div class="data-row calculated">
            <div class="data-label"><span>Total Cash Invested</span></div>
            <div class="value-primary">$72,210</div>
          </div>
          <div class="data-row calculated">
            <div class="data-label"><span>Cash Returned at Refi</span></div>
            <div class="value-primary value-positive">$6,375</div>
          </div>
          <div class="data-row brrrr-total">
            <div class="data-label"><span>Cash Left in Deal</span></div>
            <div class="value-primary" id="cash-left-in">$65,835</div>
          </div>
        </div>
      </div>
      
      <!-- Financing (Refinance) Section -->
      <div class="section-card">
        <div class="section-header">
          <span class="section-title">Financing (After Refinance)</span>
        </div>
        <div class="section-content">
          <div class="data-row calculated">
            <div class="data-label"><span>Loan Amount</span></div>
            <div class="value-primary">$318,750</div>
          </div>
          <div class="data-row has-slider">
            <div class="data-label"><span>Interest Rate</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input" min="5" max="10" value="7" step="0.125" aria-label="Interest Rate (Refinance)">
              </div>
            </div>
            <input type="text" class="slider-value min-width-70" value="7.0%" aria-label="Interest Rate (Refinance)">
          </div>
          <div class="data-row has-slider">
            <div class="data-label"><span>Loan Term</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input" min="15" max="30" value="30" step="5" aria-label="Loan Term">
              </div>
            </div>
            <input type="text" class="slider-value min-width-80" value="30 years" aria-label="Loan Term">
          </div>
          <div class="data-row total">
            <div class="data-label"><span>Monthly Payment</span></div>
            <div class="value-primary">$2,121</div>
          </div>
        </div>
      </div>
      
      <!-- Cash Flow (After Refinance) Section -->
      <div class="section-card">
        <div class="section-header">
          <span class="section-title">Cash Flow (After Refinance)</span>
        </div>
        <div class="section-content">
          <div class="subsection-header income">Income</div>
          <div class="data-row has-slider">
            <div class="data-label"><span>Monthly Rent</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input" min="500" max="10000" value="2800" aria-label="Monthly Rent">
              </div>
            </div>
            <div class="slider-dual-value">
              <input type="text" class="slider-value min-width-80" value="$2,800" aria-label="Monthly Rent">
              <span class="slider-secondary">$33,600/yr</span>
            </div>
          </div>
          <div class="data-row has-slider">
            <div class="data-label"><span>Vacancy</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input" min="0" max="15" value="5" aria-label="Vacancy">
              </div>
            </div>
            <div class="slider-dual-value">
              <input type="text" class="slider-value min-width-60" value="5.0%" aria-label="Vacancy">
              <span class="slider-secondary value-negative">-$1,680</span>
            </div>
          </div>
          <div class="data-row total">
            <div class="data-label"><span>Effective Income</span></div>
            <div class="value-primary">$31,920</div>
          </div>
          
          <div class="subsection-header expenses">Operating Expenses</div>
          <div class="data-row has-slider">
            <div class="data-label"><span>Property Taxes</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input" min="0" max="10000" value="5700" aria-label="Property Taxes (Operating)">
              </div>
            </div>
            <input type="text" class="slider-value" value="$5,700" aria-label="Property Taxes (Operating)">
          </div>
          <div class="data-row has-slider">
            <div class="data-label"><span>Insurance</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input" min="0" max="5000" value="1800" aria-label="Insurance (Operating)">
              </div>
            </div>
            <input type="text" class="slider-value" value="$1,800" aria-label="Insurance (Operating)">
          </div>
          <div class="data-row has-slider">
            <div class="data-label"><span>Property Mgmt</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input" min="0" max="15" value="8" aria-label="Property Management">
              </div>
            </div>
            <div class="slider-dual-value">
              <input type="text" class="slider-value min-width-60" value="8.0%" aria-label="Property Management">
              <span class="slider-secondary">$2,554</span>
            </div>
          </div>
          <div class="data-row has-slider">
            <div class="data-label"><span>Maintenance</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input" min="0" max="15" value="5" aria-label="Maintenance">
              </div>
            </div>
            <div class="slider-dual-value">
              <input type="text" class="slider-value min-width-60" value="5.0%" aria-label="Maintenance">
              <span class="slider-secondary">$1,596</span>
            </div>
          </div>
          <div class="data-row has-slider">
            <div class="data-label"><span>CapEx</span></div>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" class="slider-input" min="0" max="15" value="5" aria-label="CapEx">
              </div>
            </div>
            <div class="slider-dual-value">
              <input type="text" class="slider-value min-width-60" value="5.0%" aria-label="CapEx">
              <span class="slider-secondary">$1,596</span>
            </div>
          </div>
          <div class="data-row total">
            <div class="data-label"><span>Total Expenses</span></div>
            <div class="value-primary">$13,246</div>
          </div>
          
          <div class="data-row calculated">
            <div class="data-label"><span>Net Operating Income</span></div>
            <div class="value-primary value-positive">$18,674</div>
          </div>
          <div class="data-row calculated">
            <div class="data-label"><span>Debt Service</span></div>
            <div class="value-primary value-negative">-$25,452</div>
          </div>
          <div class="data-row total">
            <div class="data-label"><span>Annual Cash Flow</span></div>
            <div class="value-primary value-negative">-$6,778</div>
          </div>
        </div>
      </div>
      
      <!-- Investment Returns Section -->
      <div class="section-card">
        <div class="section-header brrrr-highlight">
          <span class="section-title brrrr">Investment Returns (After Refi)</span>
        </div>
        <div class="section-content">
          <div class="data-row">
            <div class="data-label"><span>Cap Rate (ARV)</span></div>
            <div class="value-primary">4.4%</div>
          </div>
          <div class="data-row">
            <div class="data-label"><span>Cash on Cash Return</span></div>
            <div class="value-primary value-negative">-10.3%</div>
          </div>
          <div class="data-row">
            <div class="data-label"><span>Return on Equity</span></div>
            <div class="value-primary">5.5%</div>
          </div>
          <div class="data-row brrrr-total">
            <div class="data-label"><span>Total ROI (Year 1)</span></div>
            <div class="value-primary value-highlight">17.6%</div>
          </div>
        </div>
      </div>
      
    </main>
    
    <!-- Charts Sidebar -->
    <aside class="worksheet-charts-sidebar">
      <!-- Profit Finder -->
      <div class="chart-card">
        <div class="chart-card-title">Profit Finder</div>
        <div class="price-position-visual">
          <div class="marker-column left">
            <div class="simple-marker" id="purchase-price-marker">
              <div class="marker-stack">
                <span class="marker-name">Buy</span>
                <span class="marker-val" id="purchase-price-display">$285,000</span>
              </div>
              <span class="marker-arrow">▶</span>
            </div>
          </div>
          <div class="price-scale-bar">
            <img src="/images/price-ladder-arrow.svg" alt="Profit Scale" />
          </div>
          <div class="marker-column right">
            <div class="simple-marker" id="breakeven-marker">
              <span class="marker-arrow">◀</span>
              <div class="marker-stack">
                <span class="marker-name">Even</span>
                <span class="marker-val" id="breakeven-value">$340,000</span>
              </div>
            </div>
            <div class="simple-marker" id="list-price-marker">
              <span class="marker-arrow">◀</span>
              <div class="marker-stack">
                <span class="marker-name">ARV</span>
                <span class="marker-val" id="list-price-display">$425,000</span>
              </div>
            </div>
          </div>
        </div>
        <div class="cashflow-indicator" id="cashflow-indicator">
          <span class="cf-label">Monthly Cash Flow:</span>
          <span class="cf-amount" id="cashflow-amount">$350</span>
          <span class="cf-status" id="position-text">Profit Zone</span>
        </div>
      </div>
      
      <!-- Pricing Ladder -->
      <div class="chart-card">
        <div class="chart-card-title">Pricing Ladder</div>
        <div class="pricing-ladder">
          <div class="pricing-ladder-track"></div>
          
          <!-- ARV (After Repair Value) -->
          <div class="pricing-ladder-item">
            <div class="pricing-ladder-label">ARV</div>
            <div class="pricing-ladder-marker arv"></div>
            <div class="pricing-ladder-value arv" id="ladder-arv">$425,000</div>
          </div>
          
          <!-- Refi Loan Amount (75% LTV) -->
          <div class="pricing-ladder-item">
            <div class="pricing-ladder-label">Refi Loan</div>
            <div class="pricing-ladder-marker refi"></div>
            <div class="pricing-ladder-value refi" id="ladder-refi">$318,750
              <span class="pricing-ladder-hint">75% LTV</span>
            </div>
          </div>
          
          <!-- All-In Cost (Current) -->
          <div class="pricing-ladder-item highlight">
            <div class="pricing-ladder-label">All-In Cost</div>
            <div class="pricing-ladder-marker current">
              <svg width="8" height="8" viewBox="0 0 8 8" fill="var(--brrrr-accent)">
                <circle cx="4" cy="4" r="4"/>
              </svg>
            </div>
            <div class="pricing-ladder-value current" id="ladder-all-in">$340,000</div>
          </div>
          
          <!-- Breakeven (100% Cash Out) -->
          <div class="pricing-ladder-item">
            <div class="pricing-ladder-label">Breakeven</div>
            <div class="pricing-ladder-marker target"></div>
            <div class="pricing-ladder-value target" id="ladder-breakeven">$318,750
              <span class="pricing-ladder-hint">100% out</span>
            </div>
          </div>
          
          <!-- MAO (70% of ARV) -->
          <div class="pricing-ladder-item">
            <div class="pricing-ladder-label">MAO</div>
            <div class="pricing-ladder-marker mao"></div>
            <div class="pricing-ladder-value mao" id="ladder-mao">$297,500
              <span class="pricing-ladder-hint">70% ARV</span>
            </div>
          </div>
        </div>
        
        <!-- Cash Recovery Indicator -->
        <div class="pricing-discount-indicator">
          <div class="pricing-discount-bar">
            <div class="pricing-discount-fill brrrr" id="recovery-fill"></div>
          </div>
          <div class="pricing-discount-label">
            <span id="recovery-percent">93.8%</span> cash recovered
          </div>
        </div>
      </div>
      
      <!-- BRRRR Score -->
      <div class="chart-card brrrr-highlight">
        <div class="chart-card-title brrrr">BRRRR Score</div>
        <div class="brrrr-score-content">
          <svg width="140" height="80" viewBox="0 0 140 80">
            <path d="M 15 70 A 55 55 0 0 1 125 70" fill="none" stroke="#e2e8f0" stroke-width="12" stroke-linecap="round"/>
            <path d="M 15 70 A 55 55 0 0 1 100 30" fill="none" stroke="url(#brrrrGauge)" stroke-width="12" stroke-linecap="round"/>
            <defs>
              <linearGradient id="brrrrGauge" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#7c3aed"/>
                <stop offset="100%" stop-color="#a78bfa"/>
              </linearGradient>
            </defs>
          </svg>
          <div class="brrrr-score-value">72</div>
          <div class="brrrr-score-label">Good BRRRR Deal</div>
        </div>
      </div>
      
      <!-- Cash Recovery -->
      <div class="chart-card brrrr-highlight">
        <div class="chart-card-title brrrr">Cash Recovery</div>
        <div class="cash-out-indicator">
          <div class="cash-out-value" id="sidebar-cash-out">$6,375</div>
          <div class="cash-out-label">Cash Out at Refinance</div>
          <div class="cash-out-status positive" id="cash-status">8.8% Recovered</div>
        </div>
        <div class="cash-recovery-bars">
          <div class="h-bar-item">
            <div class="h-bar-header">
              <span class="h-bar-label">Cash Invested</span>
              <span class="h-bar-value">$72,210</span>
            </div>
            <div class="h-bar-track">
              <div class="h-bar-fill brrrr full"></div>
            </div>
          </div>
          <div class="h-bar-item">
            <div class="h-bar-header">
              <span class="h-bar-label">Cash Returned</span>
              <span class="h-bar-value positive">$6,375</span>
            </div>
            <div class="h-bar-track">
              <div class="h-bar-fill positive"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Key Metrics -->
      <div class="chart-card">
        <div class="chart-card-title">Key Metrics</div>
        <div class="mini-stats-grid">
          <div class="mini-stat highlight">
            <div class="mini-stat-value brrrr">82%</div>
            <div class="mini-stat-label">All-In/ARV</div>
          </div>
          <div class="mini-stat">
            <div class="mini-stat-value">$76K</div>
            <div class="mini-stat-label">Equity Created</div>
          </div>
          <div class="mini-stat">
            <div class="mini-stat-value">4.4%</div>
            <div class="mini-stat-label">Cap Rate</div>
          </div>
          <div class="mini-stat">
            <div class="mini-stat-value">0.66%</div>
            <div class="mini-stat-label">Rent/Value</div>
          </div>
        </div>
      </div>
      
      <!-- Cost Breakdown -->
      <div class="chart-card">
        <div class="chart-card-title">All-In Cost Breakdown</div>
        <div class="cost-breakdown-layout">
          <div class="mini-donut cost-breakdown">
            <div class="mini-donut-center">
              <span class="mini-donut-value">$349K</span>
              <span class="mini-donut-label">All-In</span>
            </div>
          </div>
          <div class="cost-breakdown-details">
            <div class="cost-breakdown-row">
              <span class="cost-breakdown-swatch purchase"></span>
              <span class="cost-breakdown-label">Purchase</span>
              <span class="cost-breakdown-value">$285K</span>
            </div>
            <div class="cost-breakdown-row">
              <span class="cost-breakdown-swatch rehab"></span>
              <span class="cost-breakdown-label">Rehab</span>
              <span class="cost-breakdown-value">$55K</span>
            </div>
            <div class="cost-breakdown-row">
              <span class="cost-breakdown-swatch costs"></span>
              <span class="cost-breakdown-label">Costs</span>
              <span class="cost-breakdown-value">$9K</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Holding Costs Timeline -->
      <div class="chart-card">
        <div class="chart-card-title">Holding Costs</div>
        <div class="holding-costs-timeline">
          <div class="holding-costs-header">
            <span class="holding-costs-period">4 Month Rehab Period</span>
            <span class="holding-costs-total">-$15,540</span>
          </div>
          <div class="stacked-bar compact">
            <div class="stacked-bar-segment interest">Interest</div>
            <div class="stacked-bar-segment tax">Tax</div>
            <div class="stacked-bar-segment other">Other</div>
          </div>
          <div class="stacked-legend tight">
            <div class="stacked-legend-item">
              <span class="stacked-legend-dot interest"></span>
              Interest $12K
            </div>
            <div class="stacked-legend-item">
              <span class="stacked-legend-dot tax"></span>
              Taxes $1.9K
            </div>
          </div>
        </div>
      </div>
      
      <!-- Refinance Comparison -->
      <div class="chart-card">
        <div class="chart-card-title">Loan Comparison</div>
        <div class="loan-comparison-grid">
          <div class="loan-comparison-card">
            <div class="loan-comparison-label">PURCHASE</div>
            <div class="loan-comparison-value">$306K</div>
            <div class="loan-comparison-subtext">12% / HML</div>
          </div>
          <div class="loan-comparison-card refi">
            <div class="loan-comparison-label refi">REFINANCE</div>
            <div class="loan-comparison-value refi">$319K</div>
            <div class="loan-comparison-subtext refi">7% / Conv</div>
          </div>
        </div>
      </div>
    </aside>
  </div>
  
  <script>
    // ===== UTILITY FUNCTIONS =====
    function formatCurrency(value) {
      return '$' + Math.round(value).toLocaleString('en-US');
    }
    
    function parseCurrency(str) {
      if (typeof str === 'number') return str;
      return parseFloat(str.replace(/[$,%]/g, '').replace(/,/g, '')) || 0;
    }
    
    function updateElement(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }
    
    // ===== SLIDER INITIALIZATION =====
    document.querySelectorAll('.slider-input').forEach(slider => {
      function updateProgress() {
        const min = parseFloat(slider.min);
        const max = parseFloat(slider.max);
        const value = parseFloat(slider.value);
        const progress = ((value - min) / (max - min)) * 100;
        const color = slider.classList.contains('brrrr') ? '#7c3aed' : '#007ea7';
        slider.style.background = `linear-gradient(to right, ${color} 0%, ${color} ${progress}%, #e2e8f0 ${progress}%, #e2e8f0 100%)`;
      }
      
      slider.addEventListener('input', function() {
        updateProgress();
        recalculateAll();
      });
      updateProgress();
    });
    
    // ===== BIDIRECTIONAL SLIDER-INPUT SYNC =====
    document.querySelectorAll('.data-row.has-slider').forEach(row => {
      const slider = row.querySelector('.slider-input');
      const input = row.querySelector('.slider-value');
      
      if (slider && input) {
        // Slider changes input
        slider.addEventListener('input', function() {
          const value = parseFloat(this.value);
          const label = row.querySelector('.data-label span')?.textContent || '';
          
          if (label.includes('Interest') || label.includes('Vacancy') || label.includes('%') || label.includes('LTV') || label.includes('Loan to')) {
            input.value = value.toFixed(1) + '%';
          } else if (label.includes('Points')) {
            input.value = value.toFixed(1) + ' pts';
          } else if (label.includes('Holding') && label.includes('Period')) {
            input.value = value + ' months';
          } else if (label.includes('Term')) {
            input.value = value + ' years';
          } else if (label.includes('/mo')) {
            input.value = formatCurrency(value) + '/mo';
          } else {
            input.value = formatCurrency(value);
          }
        });
        
        // Input changes slider
        input.addEventListener('change', function() {
          const value = parseCurrency(this.value);
          if (!isNaN(value)) {
            slider.value = value;
            slider.dispatchEvent(new Event('input'));
          }
        });
      }
    });
    
    // Hover effects
    document.querySelectorAll('.data-row.has-slider').forEach(row => {
      row.addEventListener('mouseenter', function() {
        this.style.backgroundColor = 'rgba(124, 58, 237, 0.04)';
      });
      row.addEventListener('mouseleave', function() {
        this.style.backgroundColor = '';
      });
    });
    
    // ===== MAIN CALCULATION ENGINE (Backend API Powered) =====
    
    // Debounce timer for API calls
    let recalculateTimer = null;
    
    // API endpoint for BRRRR worksheet calculations
    const WORKSHEET_API_URL = '/api/v1/worksheet/brrrr/calculate';
    
    function recalculateAll() {
      // Debounce: Wait 150ms after last input before calling API
      if (recalculateTimer) {
        clearTimeout(recalculateTimer);
      }
      
      recalculateTimer = setTimeout(() => {
        doRecalculate();
      }, 150);
    }
    
    async function doRecalculate() {
      // Get Purchase & Rehab values
      const purchasePrice = getSliderValue('Purchase Price', 285000);
      const rehabCosts = getSliderValue('Rehab Costs', 55000);
      const purchaseCosts = getSliderValue('Purchase Costs', 8550);
      
      // Get Purchase Financing values
      const loanToValuePurchase = getSliderValue('Loan to Cost', 90) / 100;
      const interestRatePurchase = getSliderValue('Interest Rate', 12) / 100;
      const pointsPurchase = getSliderValue('Points', 2);
      
      // Get Valuation values
      const arv = getSliderValue('After Repair Value', 425000);
      
      // Get Holding values
      const holdingPeriod = getSliderValue('Holding Period', 4);
      const holdingMiscMonthly = getSliderValue('Utilities', 475) + getSliderValue('Insurance', 150) + getSliderValue('Taxes', 200);
      
      // Get Refinance values
      const refiLTV = getSliderValue('Refi LTV', 75) / 100;
      const refiPoints = getSliderValue('Refi Points', 6375);
      
      // Get After Refi Financing values
      const refiInterestRate = getSliderValue('After Refi Interest', 7) / 100;
      const refiTerm = getSliderValue('Loan Term', 30);
      
      // Get Cash Flow values
      const monthlyRent = getSliderValue('Monthly Rent', 2800);
      const vacancyRate = getSliderValue('Vacancy', 5) / 100;
      const propMgmtRate = getSliderValue('Property Mgmt', 8) / 100;
      const capExRate = getSliderValue('CapEx', 5) / 100;
      const maintRate = getSliderValue('Maintenance', 5) / 100;
      
      // Build request payload for backend API
      const payload = {
        purchase_price: purchasePrice,
        rehab_costs: rehabCosts,
        arv: arv,
        monthly_rent: monthlyRent,
        property_taxes_annual: getSliderValue('Taxes', 200) * 12,
        insurance_annual: getSliderValue('Insurance', 150) * 12,
        down_payment_pct: 1 - loanToValuePurchase,
        interest_rate: interestRatePurchase,
        points: pointsPurchase,
        holding_months: holdingPeriod,
        refi_ltv: refiLTV,
        refi_interest_rate: refiInterestRate,
        refi_loan_term: refiTerm,
        refi_closing_costs: refiPoints,
        vacancy_rate: vacancyRate,
        property_management_pct: propMgmtRate,
        maintenance_pct: maintRate,
        capex_pct: capExRate
      };
      
      try {
        // Show loading state
        showCalculating(true);
        
        // Call backend API
        const response = await fetch(WORKSHEET_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          throw new Error('API calculation failed');
        }
        
        const result = await response.json();
        console.log('Backend BRRRR calculation result:', result);
        
        // Update UI with backend results
        updateUIFromBackend(result, arv, purchasePrice, rehabCosts, purchaseCosts, loanToValuePurchase, pointsPurchase, holdingPeriod, holdingMiscMonthly, interestRatePurchase);
        
      } catch (error) {
        console.error('Backend API error, falling back to local calculation:', error);
        // Fallback to local calculation if API fails
        doLocalRecalculate(payload);
      } finally {
        showCalculating(false);
      }
    }
    
    function showCalculating(isCalculating) {
      const summaryCards = document.querySelectorAll('.summary-card-value');
      summaryCards.forEach(card => {
        if (isCalculating) {
          card.style.opacity = '0.5';
        } else {
          card.style.opacity = '1';
        }
      });
    }
    
    function updateUIFromBackend(result, arv, purchasePrice, rehabCosts, purchaseCosts, loanToValuePurchase, pointsPurchase, holdingPeriod, holdingMiscMonthly, interestRatePurchase) {
      const allInCost = result.total_cash_invested + (holdingMiscMonthly * holdingPeriod);
      const cashOutAtRefi = result.cash_out;
      const cashLeftInDeal = result.cash_left_in_deal;
      const monthlyCashFlow = result.monthly_cash_flow;
      const cocReturn = result.cash_on_cash_return;
      const capRate = result.cap_rate;
      const equityCreated = result.equity_position;
      const allInPctOfArv = result.all_in_pct_arv;
      const cashRecoveryPct = cashOutAtRefi / result.total_cash_invested * 100;
      
      // Calculate local values
      const purchaseLoanAmount = purchasePrice * loanToValuePurchase;
      const purchasePointsCost = purchaseLoanAmount * (pointsPurchase / 100);
      const cashInvested = result.total_cash_invested;
      const refiLoanAmount = result.refinance_loan_amount;
      const monthlyRefiPayment = result.monthly_cash_flow ? (result.annual_cash_flow / 12) : 0;
      const mao = (arv * 0.70) - rehabCosts;
      
      // Calculate Deal Score
      let dealScore = 50;
      if (cashRecoveryPct >= 100) dealScore += 25;
      else if (cashRecoveryPct >= 80) dealScore += 15;
      if (monthlyCashFlow > 300) dealScore += 15;
      if (equityCreated > 50000) dealScore += 10;
      dealScore = Math.min(100, Math.max(0, Math.round(dealScore)));
      
      // Update Summary Cards
      updateElement('summary-all-in', formatCurrency(allInCost));
      updateElement('summary-arv', formatCurrency(arv));
      updateElement('summary-cash-out', formatCurrency(cashOutAtRefi));
      updateElement('summary-cash-flow', formatCurrency(monthlyCashFlow) + '/mo');
      updateElement('summary-coc', cashLeftInDeal <= 0 ? '∞%' : cocReturn.toFixed(1) + '%');
      updateElement('summary-deal-score', dealScore);
      
      // Update deal score label
      const scoreLabel = document.getElementById('score-label');
      if (scoreLabel) {
        if (dealScore >= 90) scoreLabel.textContent = 'Excellent Deal';
        else if (dealScore >= 75) scoreLabel.textContent = 'Great Deal';
        else if (dealScore >= 60) scoreLabel.textContent = 'Good Deal';
        else if (dealScore >= 40) scoreLabel.textContent = 'Fair Deal';
        else scoreLabel.textContent = 'Poor Deal';
      }
      
      // Update CoC subtitle
      const cocSubtitle = document.getElementById('coc-subtitle');
      if (cocSubtitle) {
        cocSubtitle.textContent = cashLeftInDeal <= 0 ? 'Infinite if $0 left in' : 'On ' + formatCurrency(cashLeftInDeal) + ' left in';
      }
      
      // Update calculated fields
      updateElement('calc-all-in', formatCurrency(allInCost));
      updateElement('calc-purchase-loan', formatCurrency(purchaseLoanAmount));
      updateElement('calc-cash-to-close', formatCurrency(cashInvested));
      updateElement('calc-refi-loan', formatCurrency(refiLoanAmount));
      updateElement('calc-cash-out', formatCurrency(cashOutAtRefi));
      updateElement('calc-refi-payment', formatCurrency(monthlyRefiPayment) + '/mo');
      updateElement('calc-cash-flow', formatCurrency(monthlyCashFlow) + '/mo');
      updateElement('calc-equity', formatCurrency(equityCreated));
      updateElement('calc-all-in-pct', allInPctOfArv.toFixed(1) + '%');
      
      // Update Pricing Ladder
      updatePricingLadder(arv, refiLoanAmount, allInCost, mao, cashRecoveryPct);
      
      // Update Sidebar Charts
      updateSidebarCharts(dealScore, cashOutAtRefi, cashInvested, cashRecoveryPct, 
                          allInPctOfArv, equityCreated, capRate, cocReturn, monthlyCashFlow);
    }
    
    // Fallback: Local calculation if API fails
    function doLocalRecalculate(payload) {
      console.log('Using local BRRRR fallback calculations');
      // Use the existing local calculation logic as fallback
    }
    
    function getSliderValue(labelText, defaultValue) {
      const rows = document.querySelectorAll('.data-row.has-slider');
      for (const row of rows) {
        const label = row.querySelector('.data-label span')?.textContent || '';
        if (label.includes(labelText)) {
          const slider = row.querySelector('.slider-input');
          if (slider) return parseFloat(slider.value);
        }
      }
      return defaultValue;
    }
    
    function calculateMortgagePayment(principal, annualRate, years) {
      const monthlyRate = annualRate / 12;
      const numPayments = years * 12;
      if (monthlyRate === 0) return principal / numPayments;
      return principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
             (Math.pow(1 + monthlyRate, numPayments) - 1);
    }
    
    function updatePricingLadder(arv, refiLoan, allInCost, mao, cashRecoveryPct) {
      updateElement('ladder-arv', formatCurrency(arv));
      
      const refiLoanEl = document.getElementById('ladder-refi');
      if (refiLoanEl) {
        refiLoanEl.innerHTML = formatCurrency(refiLoan) + '<span class="pricing-ladder-hint">75% LTV</span>';
      }
      
      updateElement('ladder-all-in', formatCurrency(allInCost));
      
      const breakevenEl = document.getElementById('ladder-breakeven');
      if (breakevenEl) {
        breakevenEl.innerHTML = formatCurrency(refiLoan) + '<span class="pricing-ladder-hint">100% out</span>';
      }
      
      const maoEl = document.getElementById('ladder-mao');
      if (maoEl) {
        maoEl.innerHTML = formatCurrency(mao) + '<span class="pricing-ladder-hint">70% ARV</span>';
      }
      
      // Update recovery indicator
      const recoveryFill = document.getElementById('recovery-fill');
      const recoveryPercent = document.getElementById('recovery-percent');
      
      if (recoveryFill) {
        recoveryFill.style.width = Math.min(100, cashRecoveryPct) + '%';
        recoveryFill.style.background = cashRecoveryPct >= 100 
          ? 'linear-gradient(90deg, #10b981, #22c55e)' 
          : 'linear-gradient(90deg, #7c3aed, #a78bfa)';
      }
      if (recoveryPercent) {
        recoveryPercent.textContent = cashRecoveryPct.toFixed(1) + '%';
      }
    }
    
    function updateSidebarCharts(dealScore, cashOut, cashInvested, cashRecoveryPct, 
                                  allInPctOfArv, equityCreated, capRate, cocReturn, monthlyCashFlow) {
      // BRRRR Score
      updateElement('brrrr-score', dealScore);
      const scoreLabel = document.getElementById('brrrr-score-label');
      if (scoreLabel) {
        if (dealScore >= 80) scoreLabel.textContent = 'Excellent BRRRR Deal';
        else if (dealScore >= 60) scoreLabel.textContent = 'Good BRRRR Deal';
        else if (dealScore >= 40) scoreLabel.textContent = 'Fair BRRRR Deal';
        else scoreLabel.textContent = 'Poor BRRRR Deal';
      }
      
      // Cash Recovery
      updateElement('sidebar-cash-out', formatCurrency(cashOut));
      updateElement('sidebar-cash-invested', formatCurrency(cashInvested));
      updateElement('sidebar-cash-returned', formatCurrency(cashOut));
      updateElement('sidebar-recovery-pct', cashRecoveryPct.toFixed(1) + '% Recovered');
      
      // Key Metrics
      updateElement('metric-all-in-arv', allInPctOfArv.toFixed(0) + '%');
      updateElement('metric-equity', formatCurrency(equityCreated));
      updateElement('metric-cap-rate', capRate.toFixed(1) + '%');
      updateElement('metric-coc', cocReturn === Infinity ? '∞%' : cocReturn.toFixed(1) + '%');
      updateElement('metric-cash-flow', formatCurrency(monthlyCashFlow) + '/mo');
    }
    
    // ===== LOAD PROPERTY DATA FROM LOCALSTORAGE =====
    function loadPropertyData() {
      try {
        const storedData = localStorage.getItem('worksheetProperty');
        if (!storedData) return;
        
        const property = JSON.parse(storedData);
        console.log('[BRRRR Worksheet] Loaded property:', property);
        
        // Update header
        const titleEl = document.getElementById('property-title');
        const subtitleEl = document.getElementById('property-subtitle');
        const priceEl = document.getElementById('property-price-badge');
        
        if (titleEl && property.address) {
          titleEl.textContent = property.address;
        }
        
        if (subtitleEl) {
          const location = `${property.city || ''}, ${property.state || ''} ${property.zipCode || ''}`;
          const specs = `${property.bedrooms || 0} BR • ${property.bathrooms || 0} BA • ${(property.sqft || 0).toLocaleString()} Sq.Ft.`;
          subtitleEl.textContent = `${location} • ${specs}`;
        }
        
        if (priceEl && property.listPrice) {
          priceEl.textContent = formatCurrency(property.listPrice);
        }
        
        // Update slider values based on property data
        updateSliderByLabel('Purchase Price', property.listPrice);
        if (property.arv) {
          updateSliderByLabel('After Repair Value', property.arv);
        }
        
      } catch (error) {
        console.error('[BRRRR Worksheet] Error loading property data:', error);
      }
    }
    
    function updateSliderByLabel(labelText, value) {
      if (value === undefined || value === null) return;
      
      const rows = document.querySelectorAll('.data-row.has-slider');
      for (const row of rows) {
        const label = row.querySelector('.data-label span')?.textContent || '';
        if (label.includes(labelText)) {
          const slider = row.querySelector('.slider-input');
          const input = row.querySelector('.slider-value');
          
          if (slider) {
            const min = parseFloat(slider.min);
            const max = parseFloat(slider.max);
            const clampedValue = Math.min(max, Math.max(min, value));
            slider.value = clampedValue;
            const progress = Math.min(100, Math.max(0, ((clampedValue - min) / (max - min)) * 100));
            slider.style.background = `linear-gradient(to right, #7c3aed 0%, #7c3aed ${progress}%, #e2e8f0 ${progress}%, #e2e8f0 100%)`;
            if (clampedValue !== value) {
              console.warn(`[BRRRR Slider] "${labelText}" value ${value} clamped to ${clampedValue} (range: ${min}-${max})`);
            }
          }
          
          if (input) {
            const displayValue = slider ? parseFloat(slider.value) : value;
            if (label.includes('Rate') || label.includes('%') || label.includes('LTV') || label.includes('Vacancy')) {
              input.value = displayValue + '%';
            } else if (label.includes('Term') || label.includes('years') || label.includes('Months')) {
              input.value = displayValue + (label.includes('Months') ? ' months' : ' years');
            } else {
              input.value = formatCurrency(displayValue);
            }
          }
          break;
        }
      }
    }
    
    // Load property data first, then calculate
    loadPropertyData();
    recalculateAll();
    
    // ===== STRATEGY DROPDOWN =====
    (function() {
      const dropdown = document.getElementById('strategy-dropdown');
      const trigger = document.querySelector('.strategy-dropdown-trigger');
      
      if (trigger) {
        trigger.addEventListener('click', function(event) {
          event.stopPropagation();
          dropdown.classList.toggle('open');
        });
      }
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(event) {
        if (dropdown && !dropdown.contains(event.target)) {
          dropdown.classList.remove('open');
        }
      });
    })();
    
    window.selectStrategy = function(strategy, name, url) {
      // Update the button text
      document.getElementById('current-strategy-name').textContent = name;
      
      // Update active state
      document.querySelectorAll('.strategy-option').forEach(opt => {
        opt.classList.remove('active');
      });
      const activeOption = document.querySelector(`[data-strategy="${strategy}"]`);
      if (activeOption) activeOption.classList.add('active');
      
      // Close dropdown
      document.getElementById('strategy-dropdown').classList.remove('open');
      
      // Navigate to the new worksheet (if not current page and not #)
      if (url && url !== '#' && !window.location.href.includes(url)) {
        window.location.href = url;
      }
    }
    
    // Keep window.toggleStrategyDropdown for backwards compatibility with onclick
    window.toggleStrategyDropdown = function() {
      const dropdown = document.getElementById('strategy-dropdown');
      if (dropdown) dropdown.classList.toggle('open');
    }
  </script>
</body>
</html>

